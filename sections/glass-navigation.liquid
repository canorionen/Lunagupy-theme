{% schema %}
{
  "name": "Glass Navigation",
  "settings": [
    {
      "type": "range",
      "id": "bottom_offset",
      "min": 10,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Bottom Offset",
      "default": 35
    },
    {
      "type": "text",
      "id": "whatsapp_number",
      "label": "WhatsApp Number",
      "default": "905071520296",
      "info": "Enter your phone number (e.g., 905551234567)"
    },
    {
      "type": "number",
      "id": "free_shipping_threshold",
      "label": "Free Shipping Threshold (Amount)",
      "default": 500,
      "info": "Enter the amount for free shipping (e.g. 500 for 500 TL)"
    },
    {
      "type": "checkbox",
      "id": "show_on_mobile",
      "label": "Show on Mobile",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_on_desktop",
      "label": "Show on Desktop",
      "default": true
    },
    {
      "type": "text",
      "id": "cart_success_message",
      "label": "Cart Success Message",
      "default": "ðŸ›’ Sepete baÅŸarÄ±yla eklendi!"
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "Quick Menu (Rising Window)",
      "default": "main-menu"
    },
    {
      "type": "select",
      "id": "cart_drawer_style",
      "label": "Cart Drawer Style",
      "options": [
        { "value": "normal", "label": "Normal" },
        { "value": "glass", "label": "Liquid Glass" }
      ],
      "default": "glass"
    }
  ],
  "presets": [
    {
      "name": "Glass Navigation"
    }
  ]
}
{% endschema %}

<style>
  /* Base Styles */
  .glass-nav-wrapper {
    position: fixed;
    bottom: {{ section.settings.bottom_offset }}px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 99999;
    width: auto;
    max-width: 95vw;
    display: flex;
    justify-content: center;
    pointer-events: none;
    transition: bottom 0.3s ease;
  }

  {% unless section.settings.show_on_desktop %}
    @media screen and (min-width: 750px) {
      .glass-nav-wrapper { display: none; }
    }
  {% endunless %}

  {% unless section.settings.show_on_mobile %}
    @media screen and (max-width: 749px) {
      .glass-nav-wrapper { display: none; }
    }
  {% endunless %}

  .glass-nav-container {
    pointer-events: auto;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center; /* Changed from space-between for equal spacing */
    gap: 24px; /* Equal gap between all icons */
    padding: 16px 40px;
    border-radius: 9999px;

    /* REVISED Material System (visionOS Glass) - More White Background */
    background-color: rgba(255, 255, 255, 0.65); 
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    
    /* Stronger, more dimensional shadows and borders - More Transparent */
    box-shadow: 
      0 30px 60px -15px rgba(0, 0, 0, 0.12), 
      inset 0 0 0 1px rgba(255, 255, 255, 0.5), 
      inset 0 1px 1px 0 rgba(255, 255, 255, 0.6);
      
    transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
  }

  /* Spotlight effect layer */
  .glass-nav-spotlight-layer {
    position: absolute;
    inset: 0;
    border-radius: 9999px;
    background: radial-gradient(
      Circle 160px at var(--mouse-x, 50%) var(--mouse-y, 50%),
      rgba(255, 255, 255, 0.8),
      transparent 100%
    );
    opacity: 0;
    transition: opacity 0.5s ease;
    pointer-events: none;
    mix-blend-mode: overlay;
  }
  
  .glass-nav-item-inner {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    transition: transform 0.2s cubic-bezier(0.2, 0, 0.2, 1);
    pointer-events: none;
  }

  .glass-nav-container:hover .glass-nav-spotlight-layer {
     opacity: 1;
  }

  .glass-nav-item {
    position: relative;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    flex-shrink: 0;
    text-decoration: none;
    color: #4a4a4a; 
    border-radius: 50%;
    
    /* Initialize vars for magnetic effect */
    --mx: 0px;
    --my: 0px;
    
    /* Transition specific properties to avoid layout shifting neighbors */
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), 
                background-color 0.3s ease, 
                box-shadow 0.3s ease, 
                color 0.3s ease;
  }

  /* 
     HOVER FIX:
     Only apply the "Lift" effect on devices that support hover (mouse).
     This prevents the icon from getting "stuck" up on touch devices after tapping.
  */
  @media (hover: hover) {
    .glass-nav-item:hover {
      color: #000;
      background-color: rgba(255, 255, 255, 0.6);
      /* Removed the lifting/scaling effect as requested */
      transform: none; 
      box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255,255,255,0.8);
    }
    
    .glass-nav-item:hover .glass-nav-icon {
      /* Removed icon scaling */
      transform: none; 
    }
  }

  /* Stabilize Focus State to prevent "Second Press" glitch */
  .glass-nav-item:focus, .glass-nav-item:focus-visible {
      outline: none;
      transform: none; /* Ensure focus doesn't trigger transforms */
  }

  /* Creative "Liquid Press" Effect - Deep Inset (GÃ¶Ã§me) */
  .glass-nav-item:active {
    /* Physically move down and scale slightly */
    transform: translateY(3px) scale(0.96);
    
    /* Darken background slightly to simulate depth */
    background-color: rgba(230, 230, 235, 0.4); 
    
    /* Heavy inner shadows to create the "hole" illusion */
    box-shadow: 
      inset 0 4px 8px rgba(0, 0, 0, 0.2),      /* Top internal shadow (depth) */
      inset 0 2px 3px rgba(0, 0, 0, 0.1),      /* Sharp inner rim */
      0 0 0 transparent;                       /* Remove outer drop shadow */
      
    /* Faster transition for immediate feedback */
    transition-duration: 0.1s;
  }

  /* Stabilize icon on press: Keep magnetic position but shrink */
  .glass-nav-item:active .glass-nav-item-inner {
    transform: translate(var(--mx), var(--my)) scale(0.90) !important; 
    transition: transform 0.1s ease;
  }

  .glass-nav-icon {
    width: 32px; 
    height: 32px;
    display: block;
    fill: currentColor;
    filter: drop-shadow(0 1px 0 rgba(255,255,255,0.8));
    shape-rendering: geometricPrecision;
    transition: transform 0.3s ease;
    /* Ensure icon doesn't block clicks */
    pointer-events: none; 
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  
  /* Make Search Icon Bigger */
  #glassSearchButton .glass-nav-icon {
    width: 34px;
    height: 34px;
  }

  /* Magnetic Animation Logic via JS */
  .glass-nav-item.magnetic .glass-nav-item-inner {
    transform: translate(var(--mx, 0), var(--my, 0));
  }
  
  /* CART PROGRESS BACKGROUND */
  .cart-progress-bg {
    position: absolute;
    inset: -6px; /* Slightly larger than the item */
    border-radius: 50%;
    z-index: -1;
    overflow: hidden;
    
    /* The circular background container */
    background-color: rgba(0, 0, 0, 0.05); /* Subtle gray default */
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .cart-progress-fill {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: var(--progress-percent, 0%);
    /* Stronger, more visible color */
    background-color: rgba(223, 159, 119, 0.9); 
    transition: height 0.5s ease-out;
    
    /* Liquid glass effect on the fill */
    box-shadow: 0 0 15px rgba(223, 159, 119, 0.6); 
    backdrop-filter: blur(0px); /* Remove blur to make it clearer */
  }

  /* Notifications Stack - Above sticky add-to-cart bar */
  .glass-notifications-stack {
    position: fixed;
    bottom: 110px; /* Default: Just above Glass Nav */
    transition: bottom 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column-reverse;
    gap: 8px;
    align-items: center;
    pointer-events: none;
    z-index: 100000; /* Above everything */
    width: max-content;
  }

  /* When Sticky Cart is Visible - Move Up */
  body.sticky-cart-visible .glass-notifications-stack {
    bottom: 230px;
  }

  .glass-nav-notification {
    position: relative;
    background-color: rgba(255, 255, 255, 0.88);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-radius: 99px;
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    white-space: nowrap;
    color: #111;
    font-size: 13px;
    font-weight: 500;
    pointer-events: none;
    
    /* Animation base */
    opacity: 0;
    transform: scale(0.8) translateY(20px);
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    
    /* Collapsed state */
    height: 0;
    padding: 0 16px;
    margin: 0;
    overflow: hidden;
    display: flex;
    align-items: center;
  }

  .glass-nav-notification.show {
    opacity: 1;
    height: 38px; /* Fixed height for proper stacking */
    transform: scale(1) translateY(0);
    margin-bottom: 2px;
  }
  
  .glass-nav-item.celebrating .glass-nav-icon {
    animation: celebration-pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    color: #e67e22; /* Celebrate color */
  }
  
  .glass-nav-item.celebrating::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100%;
    height: 100%;
    margin-left: -50%;
    margin-top: -50%;
    border-radius: 50%;
    border: 2px solid #e67e22;
    opacity: 0;
    pointer-events: none;
    animation: celebration-ripple 0.8s ease-out;
  }

  @keyframes celebration-pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); }
    100% { transform: scale(1); }
  }
  @keyframes celebration-ripple {
    0% { transform: scale(0.8); opacity: 1; border-width: 6px; }
    100% { transform: scale(2.5); opacity: 0; border-width: 0px; }
  }

  /* MENU WINDOW (Liquid Glass Rise) */
  .glass-menu-window {
    position: absolute;
    bottom: 0px;
    left: 50%;
    transform: translateX(-50%) translateY(20px) scale(0.9);
    width: 260px; /* Slightly narrower */
    height: auto;
    max-height: 55vh; /* Prevent going off-screen */
    overflow-y: auto; /* Scrollable if too many items */
    
    /* Hide Scrollbar */
    scrollbar-width: none;
    -ms-overflow-style: none;

    /* Glass Effect - More White */
    background-color: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(22px) saturate(180%);
    -webkit-backdrop-filter: blur(22px) saturate(180%);
    border-radius: 18px;
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: 0 15px 35px rgba(0,0,0,0.12);
    
    z-index: -2;
    opacity: 0;
    pointer-events: none;
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    
    padding: 10px; /* Reduced padding */
    display: flex;
    flex-direction: column;
    gap: 2px; /* Reduced gap significantly */
    
    transform-origin: bottom center;
  }
  
  .glass-menu-window::-webkit-scrollbar {
    display: none;
  }

  /* SEARCH WINDOW */
  .glass-search-window {
    position: absolute;
    bottom: 0px;
    left: 50%;
    transform: translateX(-50%) translateY(20px) scale(0.9);
    width: 280px;
    height: auto;
    
    background-color: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(22px) saturate(180%);
    -webkit-backdrop-filter: blur(22px) saturate(180%);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: 0 15px 35px rgba(0,0,0,0.12);
    
    z-index: -2;
    opacity: 0;
    pointer-events: none;
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    transform-origin: bottom center;
  }

  .glass-search-window.open {
    opacity: 1;
    pointer-events: auto;
    /* Move WAY up to avoid mobile keyboard (approx top 15-20% of screen) */
    transform: translateX(-50%) translateY(-50vh) scale(1);
  }

  .glass-search-form {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
  }

  .glass-search-input {
    width: 100%;
    background: rgba(255, 255, 255, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.6);
    padding: 10px 14px;
    border-radius: 12px;
    font-size: 14px;
    color: #333;
    outline: none;
    transition: all 0.2s ease;
  }
  
  .glass-search-input:focus {
    background: rgba(255, 255, 255, 0.85);
    box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
  }

  .glass-search-btn {
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    color: #444;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: background 0.2s;
  }
  
  .glass-search-btn:hover {
    background: rgba(255, 255, 255, 0.5);
  }
  
  /* Extra space for search icon */
  #glassSearchButton .glass-nav-icon {
    padding: 3px;
  }


  /* WINDOW OPEN STATES */
  .glass-menu-window.open {
    opacity: 1;
    pointer-events: auto;
    transform: translateX(-50%) translateY(-100px) scale(1);
    z-index: 100;
  }

  .glass-search-window.open {
    opacity: 1;
    pointer-events: auto;
    /* Move WAY up to avoid mobile keyboard */
    transform: translateX(-50%) translateY(-60vh) scale(1);
    z-index: 100;
  }

  /* Responsive Adjustments - Equal Spacing */
  @media screen and (max-width: 480px) {
    .glass-nav-wrapper {
      width: 100vw;
      max-width: 100vw;
      left: 50% !important;
      bottom: 25px;
    }
    .glass-nav-container {
      padding: 10px 16px !important;
      gap: 16px !important; /* Equal gap for ALL icons */
      justify-content: center !important;
      width: auto !important;
      min-width: 0 !important;
      max-width: 95vw;
      margin: 0 auto;
    }
    .glass-nav-icon {
      width: 22px !important;
      height: 22px !important;
    }
    .glass-nav-item {
      width: 40px !important;
      height: 40px !important;
      margin: 0 !important;
      padding: 0 !important;
      flex-shrink: 0 !important; /* Prevent shrinking */
      cursor: pointer !important;
      pointer-events: auto !important;
    }
    .cart-progress-bg {
      inset: -3px;
    }
    /* Mobile notification position */
    .glass-notifications-stack {
      bottom: 95px; /* Default mobile position */
    }

    body.sticky-cart-visible .glass-notifications-stack {
      bottom: 190px; /* Mobile sticky position */
    }

    /* Make search icon bigger on mobile too */
    #glassSearchButton .glass-nav-icon {
       width: 26px !important;
       height: 26px !important;
    }
  }

  /* Hamburger and Titles */
  .glass-menu-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: #888;
    margin-bottom: 10px;
    font-weight: 800;
    text-align: center;
  }

  .glass-menu-link {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    color: #222 !important;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    border-radius: 10px;
    transition: all 0.2s ease;
  }
  
  .glass-menu-link:hover {
    background-color: rgba(255, 255, 255, 0.7);
    transform: translateX(4px);
  }

  .menu-icon-svg {
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .glass-nav-item.menu-active .menu-icon-svg {
    transform: rotate(90deg);
  }

  /* LIQUID GLASS CART DRAWER OVERRIDE */
  {% if section.settings.cart_drawer_style == 'glass' %}
  .cart-drawer__dialog {
    background-color: rgba(255, 255, 255, 0.65) !important;
    backdrop-filter: blur(25px) saturate(180%) !important;
    -webkit-backdrop-filter: blur(25px) saturate(180%) !important;
    border: 1px solid rgba(255, 255, 255, 0.5) !important;
    box-shadow: 0 20px 50px rgba(0,0,0,0.12) !important;
    
    /* Transform into a floating window */
    border-radius: 24px !important;
    height: calc(100% - 40px) !important;
    margin: 20px !important;
    width: calc(var(--sidebar-width) - 40px) !important;
    max-width: calc(100vw - 40px) !important;
    right: 0 !important;
    left: auto !important;
  }
  
  @media screen and (max-width: 749px) {
    .cart-drawer__dialog {
      /* Center cart drawer on mobile - both horizontally and vertically */
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      right: auto !important;
      bottom: auto !important;
      transform: translate(-50%, -50%) !important;
      width: calc(100vw - 40px) !important;
      max-width: 400px !important;
      height: 75vh !important; /* Fixed height for consistent layout */
      max-height: 600px !important;
      margin: 0 !important;
    }
  }

  .cart-drawer__header, 
  .cart-drawer__content, 
  .cart-drawer__summary,
  .cart-items-component {
    background-color: transparent !important;
    background: transparent !important;
  }

  .cart-drawer__inner {
    border-radius: 24px !important;
    overflow: hidden !important;
    display: flex !important;
    flex-direction: column !important;
    height: 100% !important;
  }

  /* Fixed header at top */
  .cart-drawer__header {
    flex-shrink: 0 !important;
    padding: 16px !important;
  }

  /* Scrollable content area */
  .cart-drawer__content {
    flex: 1 !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    min-height: 0 !important; /* Important for flex scroll */
  }

  /* Fixed summary/footer at bottom - always visible */
  .cart-drawer__summary {
    flex-shrink: 0 !important;
    mask-image: none !important;
    border-top: 1px solid rgba(255, 255, 255, 0.4) !important;
    padding: 16px !important;
    background-color: rgba(255, 255, 255, 0.7) !important;
    backdrop-filter: blur(10px) !important;
    -webkit-backdrop-filter: blur(10px) !important;
  }

  /* Make cart items scrollable */
  .cart-items-component {
    overflow-y: visible !important;
  }

  /* Custom scrollbar for glass effect */
  .cart-drawer__content::-webkit-scrollbar {
    width: 6px;
  }
  
  .cart-drawer__content::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 3px;
  }
  
  .cart-drawer__content::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.15);
    border-radius: 3px;
  }
  
  .cart-drawer__content::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.25);
  }
  {% endif %}
</style>

<div class="glass-nav-wrapper">
  <div class="glass-notifications-stack">
    <div id="GlassNotification" class="glass-nav-notification">
      âœ¨ Ãœcretsiz kargoya hak kazandÄ±n!
    </div>
    <div id="CartSuccessNotification" class="glass-nav-notification">
      {{ section.settings.cart_success_message }}
    </div>
  </div>
  <div class="glass-menu-window" id="GlassMenuWindow">
    <div class="glass-menu-title">{{ section.settings.menu.title | default: 'MENÃœ' }}</div>
    {%- if section.settings.menu.links.size > 0 -%}
      {%- for link in section.settings.menu.links -%}
        <a href="{{ link.url }}" class="glass-menu-link">{{ link.title }}</a>
      {%- endfor -%}
    {%- else -%}
      <div style="padding: 10px; font-size: 13px; color: #888;">MenÃ¼ seÃ§ilmedi.</div>
    {%- endif -%}
  </div>

  <div class="glass-search-window" id="GlassSearchWindow">
    <form action="{{ routes.search_url }}" method="get" role="search" class="glass-search-form">
      <input
        type="text"
        name="q"
        id="GlassSearchInput"
        class="glass-search-input"
        placeholder="Ara..."
        autocomplete="off"
      >
      <button type="submit" class="glass-search-btn" aria-label="Ara">
        <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
          <path clip-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06zM10.5 7a3.5 3.5 0 1 1-7 0a3.5 3.5 0 0 1 7 0" fill-rule="evenodd"></path>
        </svg>
      </button>
    </form>
  </div>

  <nav class="glass-nav-container" id="GlassNavContainer">
    <div class="glass-nav-spotlight-layer"></div>
    
    <!-- Menu Button (Trigger) -->
    <div class="glass-nav-item" id="glassMenuButton" role="button" aria-label="MenÃ¼">
      <div class="glass-nav-item-inner">
         <svg class="glass-nav-icon menu-icon-svg" viewBox="0 0 16 16" fill="currentColor">
            <path clip-rule="evenodd" d="M2 3.75A.75.75 0 0 1 2.75 3h10.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 3.75M2 8a.75.75 0 0 1 .75-.75h10.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 8m0 4.25a.75.75 0 0 1 .75-.75h10.5a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1-.75-.75" fill-rule="evenodd"></path>
         </svg>
      </div>
    </div>

    <!-- Search Button (Trigger) -->
    <div class="glass-nav-item" id="glassSearchButton" role="button" aria-label="Ara">
      <div class="glass-nav-item-inner">
         <svg class="glass-nav-icon" viewBox="0 0 16 16" fill="currentColor">
            <path clip-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06zM10.5 7a3.5 3.5 0 1 1-7 0a3.5 3.5 0 0 1 7 0" fill-rule="evenodd"></path>
         </svg>
      </div>
    </div>
    
    <!-- Cart Icon with Liquid Progress -->
    {%- assign threshold = section.settings.free_shipping_threshold | times: 100.0 -%}
    {%- assign cart_total = cart.total_price | times: 1.0 -%}
    {%- assign progress = 0 -%}
    {%- if threshold > 0 -%}
      {%- assign progress = cart_total | divided_by: threshold | times: 100 -%}
    {%- endif -%}
    {%- if progress > 100 -%}{%- assign progress = 100 -%}{%- endif -%}

    <a href="{{ routes.cart_url }}" class="glass-nav-item" aria-label="Sepet" id="cartNavIcon">
      <div class="glass-nav-item-inner">
        <!-- Progress Background -->
        <div class="cart-progress-bg">
          <div class="cart-progress-fill" style="--progress-percent: {{ progress }}%;"></div>
        </div>
        
        <svg class="glass-nav-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M7.548 22.253a1.25 1.25 0 1 1 0-2.5a1.25 1.25 0 0 1 0 2.5m10.4 0a1.25 1.25 0 1 1 0-2.5a1.25 1.25 0 0 1 0 2.5m3.08-14.7a.682.682 0 0 0 0-.14a2.48 2.48 0 0 0-1.49-1.61a4.68 4.68 0 0 0-1.8-.28H5.228l-.79-3.2a.75.75 0 1 0-1.46.35l.94 3.78c.52 2 .94 3.76 1.3 5.43c0 .14 0 .27.08.4c.12.52.24 1.05.33 1.56c.12.74.29 1.472.51 2.19c.163.396.429.741.77 1a2.48 2.48 0 0 0 1.18.46h.91c.273.015.547.015.82 0h6.73a3.06 3.06 0 0 0 2.26-.78l.08-.08a3.67 3.67 0 0 0 .78-1.9c.16-.93.37-1.88.56-2.77a.43.43 0 0 0 0-.11c.06-.22.1-.44.15-.65c.05-.21.11-.52.17-.79c.06-.27.13-.62.17-.83a4.48 4.48 0 0 0 .31-2.03m-2.81 7a2.06 2.06 0 0 1-.43 1.11a1.44 1.44 0 0 1-.48.28a1.67 1.67 0 0 1-.66.07h-6.92a8.462 8.462 0 0 1-1.51 0a1.001 1.001 0 0 1-.43-.17a.91.91 0 0 1-.26-.29a15.438 15.438 0 0 1-.44-1.93c-.07-.37-.15-.74-.22-1.11h11.75c-.14.63-.28 1.31-.4 2.01z"></path>
        </svg>
      </div>
    </a>
    
    <!-- Home Icon -->
    <a href="{{ routes.root_url }}" class="glass-nav-item" aria-label="Ana Sayfa">
      <div class="glass-nav-item-inner">
        <svg class="glass-nav-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M21.205 7.765a2.93 2.93 0 0 0-1.16-1.28l-6.47-4a3 3 0 0 0-3.16 0l-6.47 4a3 3 0 0 0-1.12 1.29a2.92 2.92 0 0 0-.24 1.7l1.68 10a2.94 2.94 0 0 0 1 1.79a3 3 0 0 0 1.9.7h9.62a3 3 0 0 0 1.94-.7a2.9 2.9 0 0 0 1-1.79l1.68-10a3 3 0 0 0-.2-1.71m-5.86 9.7h-6.69a1 1 0 0 1 0-2h6.69a1 1 0 1 1 0 2"></path>
        </svg>
      </div>
    </a>

    <!-- WhatsApp Icon -->
    {% assign whatsapp_url = 'https://wa.me/' | append: section.settings.whatsapp_number %}
    {% if section.settings.whatsapp_number == blank %}
      {% assign whatsapp_url = '#' %}
    {% endif %}
    
    <a href="{{ whatsapp_url }}" class="glass-nav-item" aria-label="WhatsApp" {% if section.settings.whatsapp_number != blank %}target="_blank"{% endif %}>
      <div class="glass-nav-item-inner">
        <svg class="glass-nav-icon" viewBox="0 0 432 432" fill="currentColor">
           <path d="M364.5 65Q427 127 427 214.5T364.5 364T214 426q-54 0-101-26L0 429l30-109Q2 271 2 214q0-87 62-149T214 3t150.5 62zM214 390q73 0 125-51.5T391 214T339 89.5T214 38T89.5 89.5T38 214q0 51 27 94l4 6l-18 65l67-17l6 3q42 25 90 25zm97-132q9 5 10 7q4 6-3 25q-3 8-15 15.5t-21 9.5q-18 2-33-2q-17-6-30-11q-8-4-15.5-8.5t-14.5-9t-13-9.5t-11.5-10t-10.5-10.5t-8.5-9.5t-7-8.5t-5.5-7t-3.5-5L128 222q-22-29-22-55q0-24 19-44q6-7 14-7q6 0 10 1q8 0 12 9q2 3 6 13l7 17.5l3 8.5q3 5 1 9q-3 7-5 9l-3 3l-3 3.5l-2 2.5q-6 6-3 11q13 22 30 37q13 11 43 26q7 3 11-1q12-15 17-21q4-6 12-3q6 3 36 17z"></path>
        </svg>
      </div>
    </a>

  </nav>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const navContainer = document.getElementById('GlassNavContainer');
    
    // 1. Spotlight Effect (Magnetic Removed)
    if (navContainer) {
        navContainer.addEventListener('mousemove', (e) => {
            const rect = navContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            navContainer.style.setProperty('--mouse-x', `${x}px`);
            navContainer.style.setProperty('--mouse-y', `${y}px`);
        });
    }

    // 2. Dynamic Cart Progress
    // Get threshold from settings (in cents)
    const shippingThreshold = {{ section.settings.free_shipping_threshold | times: 100 }};
    
    function updateGlassCartProgress() {
       fetch(window.Shopify.routes.root + 'cart.js')
       .then(response => response.json())
       .then(cart => {
          const total = cart.total_price;
          let percent = 0;
          
          if (shippingThreshold > 0) {
             percent = (total / shippingThreshold) * 100;
          }
          if (percent > 100) percent = 100;
          
          const fillElement = document.querySelector('.cart-progress-fill');
          if (fillElement) {
             fillElement.style.setProperty('--progress-percent', percent + '%');
          }
          
          // Trigger celebration if 100% reached
          if (percent >= 100) {
              const cartIcon = document.getElementById('cartNavIcon');
              const notification = document.getElementById('GlassNotification');
              
              if (cartIcon && !cartIcon.classList.contains('celebrated')) {
                  cartIcon.classList.add('celebrating');
                  cartIcon.classList.add('celebrated'); 
                  
                  // Show Notification
                  if (notification) {
                    notification.classList.add('show');
                    // Hide after 4 seconds
                    setTimeout(() => {
                      notification.classList.remove('show');
                    }, 4000);
                  }

                  setTimeout(() => {
                      cartIcon.classList.remove('celebrating');
                  }, 1000);
              }
          } else {
             // If drops below 100 (item removed), remove flag so it can celebrate again
             const cartIcon = document.getElementById('cartNavIcon');
             const notification = document.getElementById('GlassNotification');
             if (cartIcon) cartIcon.classList.remove('celebrated');
             if (notification) notification.classList.remove('show');
          }
       })
       .catch(err => console.error('GlassNav Cart Error:', err));
    }

    // 3. Show Cart Success Notification
    function showCartSuccessNotification() {
        const successNotification = document.getElementById('CartSuccessNotification');
        if (successNotification) {
            successNotification.classList.add('show');
            setTimeout(() => {
                successNotification.classList.remove('show');
            }, 3000);
        }
    }

    // Intercept standard Fetch API requests to detect cart changes
    const originalFetch = window.fetch;
    window.fetch = function() {
        return originalFetch.apply(this, arguments).then((response) => {
            // Check if the URL involves cart operations
            if (response.url && response.url.includes('/cart/add')) {
                showCartSuccessNotification();
            }
            
            if (response.url && (
                response.url.includes('/cart/add') || 
                response.url.includes('/cart/update') || 
                response.url.includes('/cart/change') ||
                response.url.includes('/cart/clear')
            )) {
                 // Wait slightly for Shopify to process, then update our specific bar
                 setTimeout(updateGlassCartProgress, 500);
            }
            return response;
        });
    };

    // Intercept XHR (for older themes/apps using jQuery or axios)
    const originalOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function() {
        this.addEventListener('load', function() {
            if (this.responseURL && this.responseURL.includes('/cart/add')) {
                showCartSuccessNotification();
            }

            if (this.responseURL && (
                this.responseURL.includes('/cart/add') || 
                this.responseURL.includes('/cart/update') || 
                this.responseURL.includes('/cart/change') ||
                this.responseURL.includes('/cart/clear')
            )) {
                 setTimeout(updateGlassCartProgress, 500);
            }
        });
        originalOpen.apply(this, arguments);
    };

    // 4. Fix "Stuck" Hover on Back Navigation
    window.addEventListener('pageshow', (event) => {
        // Reset navigation bar animation/state on back button
        const navItems = document.querySelectorAll('.glass-nav-item');
        navItems.forEach(item => {
            // Remove any temporary animation classes if they exist
            item.classList.remove('celebrating');
            // Force a reflow to "reset" CSS states
            item.style.animation = 'none';
            item.offsetHeight; 
            item.style.animation = '';
            
            // Explicitly reset magnetic vars
            item.classList.remove('magnetic');
            item.style.setProperty('--mx', '0px');
            item.style.setProperty('--my', '0px');
        });
    });

    // 5. Menu & Search Toggle Logic (Optimized)
    const menuBtn = document.getElementById('glassMenuButton');
    const menuWin = document.getElementById('GlassMenuWindow');
    const searchBtn = document.getElementById('glassSearchButton');
    const searchWin = document.getElementById('GlassSearchWindow');
    const searchInp = document.getElementById('GlassSearchInput');

    function closeAll() {
        if(menuWin) menuWin.classList.remove('open');
        if(menuBtn) menuBtn.classList.remove('menu-active');
        if(searchWin) searchWin.classList.remove('open');
    }

    if (menuBtn && menuWin) {
        menuBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const isOpen = menuWin.classList.contains('open');
            closeAll();
            if (!isOpen) {
                menuWin.classList.add('open');
                this.classList.add('menu-active');
            }
        });
    }

    if (searchBtn && searchWin) {
        searchBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const isOpen = searchWin.classList.contains('open');
            closeAll();
            if (!isOpen) {
                searchWin.classList.add('open');
                if(searchInp) {
                    setTimeout(() => searchInp.focus(), 150);
                }
            }
        });
    }

    const cartBtn = document.getElementById('cartNavIcon');
    if (cartBtn) {
        cartBtn.addEventListener('click', function(e) {
            const drawer = document.querySelector('cart-drawer-component');
            if (drawer) {
                e.preventDefault();
                e.stopPropagation();
                closeAll();
                drawer.open();
            }
        });
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.glass-menu-window') && 
            !e.target.closest('.glass-search-window') && 
            !e.target.closest('.glass-nav-item')) {
            closeAll();
        }
    });

    // Close menu on link click
    if(menuWin) {
        menuWin.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => closeAll());
        });
    }
});
</script>
