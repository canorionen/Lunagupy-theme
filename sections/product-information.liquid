

<script type="application/ld+json">
  {{ closest.product | structured_data }}
</script>

{% capture media_gallery %}
  {%- content_for 'block',
    type: '_product-media-gallery',
    id: 'media-gallery',
    closest.product: closest.product
  -%}
{% endcapture %}

{% capture product_details %}
  {% content_for 'block',
    type: '_product-details',
    id: 'product-details',
    closest.product: closest.product
  %}
{% endcapture %}

{% capture additional_blocks %}
  {% content_for 'blocks' %}
{% endcapture %}

{% if section.settings.enable_sticky_add_to_cart %}
  {% liquid
    assign current_variant = product.selected_or_first_available_variant
    # Get the initial quantity based on quantity rules
    assign initial_quantity = current_variant.quantity_rule.min | default: 1
  %}

  <sticky-add-to-cart
    class="sticky-add-to-cart"
    data-variant-available="{{ current_variant.available }}"
    data-product-id="{{ product.id }}"
    data-current-variant-id="{{ current_variant.id }}"
    data-initial-quantity="{{ initial_quantity }}"
    data-default-variant-title="{{ 'products.product.default_title' | t }}"
  >
    <div
      class="sticky-add-to-cart__bar color-{{ settings.popover_color_scheme }}"
      data-stuck="false"
      ref="stickyBar"
      role="region"
      aria-label="{{ 'products.product.sticky_add_to_cart' | t }}"
    >
      {% liquid
        assign image_to_show = current_variant.featured_image | default: product.featured_image
      %}
      {% if image_to_show %}
        <div
          class="sticky-add-to-cart__image"
        >
          {% assign image_alt = image_to_show.alt | default: product.title | escape %}
          {{
            image_to_show
            | image_url: width: 120
            | image_tag:
              loading: 'lazy',
              alt: image_alt,
              class: 'sticky-add-to-cart__image-img',
              data-testid: 'sticky-product-image',
              srcset: null,
              sizes: null,
              ref: 'productImage'
          }}
        </div>
      {% endif %}



      <button
        type="button"
        class="sticky-add-to-cart__button add-to-cart-button button button--primary"
        ref="addToCartButton"
        on:click="/handleAddToCartClick"
        {% unless current_variant.available %}
          disabled
        {% endunless %}
      >
        <span
          class="add-to-cart-text"
        >
          {% if current_variant.available %}
            <span class="svg-wrapper add-to-cart-icon">
              {{- 'icon-add-to-cart.svg' | inline_asset_content -}}
            </span>
          {% endif %}
          <span class="add-to-cart-text__content">
            <span>
              {%- if current_variant.available -%}
                {{- 'products.product.add_to_cart' | t -}}
              {%- elsif current_variant == blank -%}
                {{- 'products.product.unavailable' | t -}}
              {%- else -%}
                {{- 'products.product.sold_out' | t -}}
              {%- endif -%}
            </span>
            <span
              class="quantity-display"
              ref="quantityDisplay"
              {% if current_variant.available and initial_quantity > 1 %}
                style="display: inline;"
              {% else %}
                style="display: none;"
              {% endif %}
            >
              {{- ' (' -}}
              <span ref="quantityNumber">{{- initial_quantity -}}</span>
              {{- ')' -}}
            </span>
          </span>
        </span>
        <span class="add-to-cart__added">
          <span class="svg-wrapper add-to-cart__added-icon">
            {{- 'icon-checkmark-burst.svg' | inline_asset_content -}}
          </span>
        </span>
      </button>
    </div>
  </sticky-add-to-cart>
{% endif %}

{% render 'product-information-content',
  product_media_size: closest.product.media.size,
  section_id: section.id,
  settings: section.settings,
  media_gallery: media_gallery,
  product_details: product_details,
  additional_blocks: additional_blocks
%}

{% stylesheet %}
  .sticky-add-to-cart__bar {
    position: fixed;
    /* Position above glass navigation bar */
    bottom: 170px; /* Increased to avoid nav bar overlap */
    left: 50%;
    opacity: 0;
    transform: translateX(-50%) translateY(calc(100% + 40px));
    z-index: 99998; /* Just below notifications, above nav */
    display: block;
    width: 600px;
    max-width: calc(100% - 32px);
    
    /* Liquid Glass Effect */
    background: rgba(255, 255, 255, 0.82);
    backdrop-filter: blur(22px) saturate(180%);
    -webkit-backdrop-filter: blur(22px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.6);
    border-radius: 9999px;
    box-shadow: 
      0 20px 50px rgba(0, 0, 0, 0.12),
      inset 0 1px 0 rgba(255, 255, 255, 0.8);
    
    padding: 10px 16px 10px 10px;
    
    /* Layout styling */
    display: flex;
    align-items: center;
    justify-content: center; /* Center content since we only have image and button */
    gap: var(--gap-md);

    @starting-style {
      opacity: 0;
      transform: translateX(-50%) translateY(calc(100% + 40px));
    }
  }

  @media (prefers-reduced-motion: no-preference) {
    .sticky-add-to-cart__bar {
      transition-property: transform, opacity, display;
      transition-duration: 0.4s;
      transition-timing-function: cubic-bezier(0.19, 1, 0.22, 1);
      transition-behavior: allow-discrete;
    }
  }

  .sticky-add-to-cart__bar[data-stuck='true'] {
    transform: translateX(-50%) translateY(0%);
    opacity: 1;
  }

  sticky-add-to-cart:not([data-variant-available='true']) .sticky-add-to-cart__bar {
    opacity: 0;
    transform: translateX(-50%) translateY(calc(100% + 40px));
    display: none;
  }

  .sticky-add-to-cart__info[data-has-image='false'] {
    padding-left: var(--padding-lg);
  }

  .sticky-add-to-cart__image {
    flex-shrink: 0;
    aspect-ratio: 1;
    width: 44px;
    height: 44px;
    overflow: hidden;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.5);
  }

  .sticky-add-to-cart__image-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .sticky-add-to-cart__info {
    display: none;
  }

  .sticky-add-to-cart__title {
    font-size: 0.9rem;
    font-weight: 600;
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: #111;
  }

  .sticky-add-to-cart__variant {
    color: #666;
    font-size: 0.8rem;
    margin-top: 2px;
  }

  .sticky-add-to-cart__price {
    display: none;
  }

  .sticky-add-to-cart__button {
    height: 44px;
    min-width: 44px;
    padding: 0 20px;
    position: relative;
    border-radius: 9999px;
    
    /* Brand Color Button */
    background: var(--brand-primary-color, #f3be99) !important;
    color: #fff !important;
    border: none !important;
    box-shadow: 0 4px 15px rgba(243, 190, 153, 0.4) !important;
    transition: all 0.3s ease !important;
  }
  
  .sticky-add-to-cart__button:hover {
    background: var(--brand-primary-color-dark, #e5a577) !important;
    transform: scale(1.02);
    box-shadow: 0 6px 20px rgba(243, 190, 153, 0.5) !important;
  }
  
  .sticky-add-to-cart__button:active {
    transform: scale(0.98);
  }

  /* Mobile adjustments - Above mobile nav bar */
  @media screen and (max-width: 749px) {
    .sticky-add-to-cart__bar {
      bottom: 180px; /* Safe distance above nav bar */
      width: auto;
      max-width: calc(100% - 24px);
      padding: 8px 12px 8px 8px;
      gap: 8px;
      border-radius: 9999px;
    }

    .sticky-add-to-cart__info[data-has-image='false'] {
      padding-left: var(--padding-sm);
    }

    .sticky-add-to-cart__image {
      width: 38px;
      height: 38px;
    }

    .sticky-add-to-cart__info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .sticky-add-to-cart__title {
      font-size: 0.82rem;
      max-width: 150px; /* Increased for better visibility */
      display: block !important;
      line-height: 1.2;
    }

    .sticky-add-to-cart__button {
      height: 38px;
      min-width: 120px; /* Increased for better width */
      padding: 0 20px;
      flex-shrink: 0;
    }

    .sticky-add-to-cart__price {
      display: none; /* Keep price hidden to save space for text */
    }
    
    /* Hide variant on mobile - ONLY for sticky bar */
    .sticky-add-to-cart__variant {
      display: none;
    }
    
    /* Show button text on mobile */
    .sticky-add-to-cart__button .add-to-cart-text__content {
      display: inline;
      font-size: 0.85rem;
      margin-left: 4px;
    }
  }

  /* Small mobile - compact mode */
  @media screen and (max-width: 480px) {
    .sticky-add-to-cart__bar {
      bottom: 180px; /* Increased further to avoid any overlap */
      padding: 6px 10px 6px 6px;
      gap: 6px;
    }
    
    .sticky-add-to-cart__image {
      width: 34px;
      height: 34px;
    }

    .sticky-add-to-cart__title {
      font-size: 0.75rem;
      max-width: 100px;
      display: block !important;
    }
    
    .sticky-add-to-cart__price {
      display: none;
    }

    .sticky-add-to-cart__button {
      height: 36px;
      min-width: 110px;
      padding: 0 15px;
    }
    
    .sticky-add-to-cart__button .add-to-cart-text__content {
      display: inline;
      font-size: 0.8rem;
    }
  }

  /* Very small screens - still show title */
  @media screen and (max-width: 340px) {
    .sticky-add-to-cart__bar {
      bottom: 180px;
      padding: 5px 8px 5px 5px;
      gap: 5px;
    }
    
    .sticky-add-to-cart__image {
      width: 30px;
      height: 30px;
    }
    
    .sticky-add-to-cart__title {
      font-size: 0.7rem;
      max-width: 70px;
    }
    
    .sticky-add-to-cart__price {
      font-size: 0.7rem;
    }
    
    .sticky-add-to-cart__button {
      height: 30px;
      min-width: 100px;
      padding: 0 12px;
    }
    
    .sticky-add-to-cart__button .add-to-cart-text__content {
      display: inline;
      font-size: 0.75rem;
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:names.product_information",
  "blocks": [
    {
      "type": "@app"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "header",
      "content": "t:content.layout"
    },
    {
      "type": "select",
      "id": "content_width",
      "label": "t:settings.width",
      "options": [
        {
          "value": "content-center-aligned",
          "label": "t:options.page"
        },
        {
          "value": "content-full-width",
          "label": "t:options.full"
        }
      ],
      "default": "content-center-aligned"
    },
    {
      "type": "select",
      "id": "desktop_media_position",
      "label": "t:settings.media_position",
      "options": [
        {
          "value": "left",
          "label": "t:options.left"
        },
        {
          "value": "right",
          "label": "t:options.right"
        }
      ],
      "default": "left"
    },
    {
      "type": "checkbox",
      "id": "equal_columns",
      "label": "t:settings.equal_columns",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "limit_details_width",
      "label": "t:settings.limit_product_details_width",
      "default": false,
      "visible_if": "{{ section.settings.equal_columns }}"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "t:settings.gap",
      "min": 0,
      "max": 48,
      "step": 4,
      "unit": "px",
      "default": 16
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_add_to_cart",
      "label": "t:settings.enable_sticky_add_to_cart",
      "default": true
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": []
}
{% endschema %}
